package com.oubaydos.backend.audio.service;

import com.oubaydos.backend.audio.Token;
import com.oubaydos.backend.audio.TokenRepository;
import lombok.AllArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.Optional;
import java.util.UUID;

@Service
@Transactional
@AllArgsConstructor
@Log4j2
public class TokenService {

    private final TokenRepository tokenRepository;

    public boolean isValid(String id) {
        Optional<Token> token = tokenRepository.findById(id);
        if (token.isEmpty())
            return false;
        return token.get().getCount() <= 1;
    }

    public void incrementCount(String id) {
        Token token = tokenRepository.findById(id).orElseThrow();
        token.setCount(token.getCount() + 1);
    }

    public String generateToken() {
        Token token = new Token(UUID.randomUUID().toString());
        return tokenRepository.save(token).getId();
    }
}
