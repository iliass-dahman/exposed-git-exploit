from time import sleep
from speach_to_text import convert_audio
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
from threading import Lock
lock = Lock()


def check_captcha(driver):
    try:
        driver.find_element(By.ID, "infoDiv")
        print("Captcha detected")
        return True
    except:
        print("No captcha")
        return False


# Slow typing
def slow_typing(driver, text):
    input = driver.find_element(By.ID, "audio-response")
    for letter in text:
        input.send_keys(letter)
        sleep(0.3)
    sleep(2)
    print("Submitting ...")
    input.send_keys(Keys.ENTER)


# Bypassing the captcha
def bypass_captcha(driver):
    while check_captcha(driver):
        sleep(2)
        print("Trying to bypass captcha")
        driver.find_element(By.ID, "recaptcha").click()
        sleep(3)
        frames = driver.find_elements(By.TAG_NAME, "iframe")
        print("Searching the frame in ", len(frames), " frames")
        found = False
        for frame in frames:
            print("****frame number: ", frames.index(frame))
            driver.switch_to.frame(frame)
            sleep(2)
            try:
                driver.find_element(By.ID, "recaptcha-audio-button").click()
                print("Audio button found")
                found = True
                break
            except:
                print("No audio button")
            driver.switch_to.default_content()
        sleep(2)
        if not found:
            return False
        print(driver.find_element(By.CLASS_NAME, "rc-audiochallenge-error-message").is_displayed())
        listen_captcha(driver)
        return True


def listen_captcha(driver):
    
    print("Listening to captcha")
    audio_link = driver.find_element(By.ID, "audio-source").get_attribute("src")
    print("Audio link: ", audio_link)
    lock.acquire()
    text = convert_audio(audio_link)
    lock.release()
    slow_typing(driver, text)
    sleep(1)
    try:
        driver.find_element(By.CLASS_NAME, "rc-audiochallenge-error-message")
        print("Captcha failed")
        listen_captcha(driver)
    except:
        print("Captcha bypassed")
        



